<!DOCTYPE html>
<html>
<head>
    <title>phySQL</title>
    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <!-- Import Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            color: white;
        }
        body {
            background-color: black;
        }
        #container {
            width: 800px;
            height: 480px;
            background-color: white;
            position: relative;
        }
        #chart-container {
            width: 100%;
            height: 100%;
        }
        #chart-container img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #qr-code {
            opacity: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #microphone-input {
            position: absolute;
            bottom: 16px;
            left: 16px;
            width: calc(100% - 32px);
            background-color: black;
            color: white;
            text-align: center;
            line-height: 24px;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="chart-container">
            <img id="chart-image" alt="sample-chart" />
            <div id="microphone-input">
                "Your input here."
            </div>
        </div>
        <div id="qr-code"></div>
    </div>
    <script type="text/javascript">
        async function fetchDataAndRenderChart() {
            // Get query param `index`
            const urlParams = new URLSearchParams(window.location.search);
            const index = urlParams.get("index");
            const instruction = urlParams.get("instruction");

            try {
                const response = await fetch(`https://app.outerbase.com/api/v1/ezql`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Source-Token': 'mm124dmh81lp169kuf8jpnxlnpeywdj1nmp3tqh6xaycebm7j7ifzr7y55z2bnc6',
                    },
                    body: JSON.stringify({
                        query: instruction,
                        run: true,
                    }),
                });

                const json = await response.json();
                const items = json.response?.results?.items ?? [];

                const data = items.map((item) => {
                    return {
                        x: item.x,
                        y: item.y,
                        type: 'scatter',
                        mode: 'lines+markers',
                        marker: { color: 'black' },
                    };
                });

                const layout = {
                    title: 'Observable Plotly Chart',
                    xaxis: { title: 'X Axis' },
                    yaxis: { title: 'Y Axis' },
                };

                Plotly.newPlot('chart-container', data, layout);

                // Update the `#chart-image` src based on index like `sample-chart-${index}.svg`
                // document.getElementById("chart-image").src = `./sample-chart${index}.svg`;

                // Update the `#microphone-input` text based on prompt
                if (instruction) {
                    document.getElementById("microphone-input").innerText = `"${instruction}"`;
                } else {
                    document.getElementById("microphone-input").innerText = ``;
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        fetchDataAndRenderChart();
    </script>
</body>
</html>
