<!DOCTYPE html>
<html>
<head>
    <title>phySQL</title>
    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <!-- Import Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            color: white;
        }
        body {
            background-color: black;
        }
        #container {
            width: 800px;
            height: 480px;
            background-color: white;
            position: relative;
        }
        #chart-container {
            width: 100%;
            height: 100%;
        }
        #chart-container img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #qr-code {
            opacity: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #microphone-input {
            position: absolute;
            bottom: 16px;
            left: 16px;
            width: calc(100% - 32px);
            background-color: black;
            color: white;
            text-align: center;
            line-height: 24px;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="chart-container">
            <!-- <img id="chart-image" alt="sample-chart" /> -->
            <div id="microphone-input">
                "Your input here."
            </div>
        </div>
        <!-- <div id="qr-code"></div> -->
    </div>
    <script type="text/javascript">
        async function fetchDataAndRenderChart() {
            // Get query param `index`
            const urlParams = new URLSearchParams(window.location.search);
            const index = urlParams.get("index");
            const instruction = urlParams.get("instruction");

            try {
                const response = await fetch(`https://app.outerbase.com/api/v1/ezql`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Source-Token': 'nq32f5pbaa72nlrwtf6rdqi1ik5pf4vpnlq6djpgzw9yee1j6dcd3isshvwnd4aj',
                    },
                    body: JSON.stringify({
                        query: `${instruction}. Return the data with an 'x' and 'y' key value pair to render a bar chart.`,
                        run: true,
                    }),
                });

                const json = await response.json();
                let items = json.response?.results?.items ?? [];

                // items =  [
                //     { x: '2024-06-29', y: '11' },
                //     { x: '2024-06-30', y: '19' },
                //     { x: '2024-07-01', y: '31' },
                //     { x: '2024-07-02', y: '39' },
                //     { x: '2024-07-03', y: '53' },
                //     { x: '2024-07-04', y: '31' },
                //     { x: '2024-07-05', y: '23' },
                //     { x: '2024-07-06', y: '12' }
                // ];

                const xValues = items.map(item => item.x);
                const yValues = items.map(item => Number(item.y));

                const data = [{
                    x: xValues,
                    y: yValues,
                    type: 'bar',
                    marker: { color: 'black' },
                }];

                // const data = items.map((item) => {
                //     return {
                //         x: new Date(item.x),
                //         y: Number(item.y),
                //         type: 'bar',
                //         marker: { color: 'black' },
                //     };
                // });

                // console.log('Data: ', data)

                const layout = {
                    // title: 'Observable Plotly Bar Chart',
                    // xaxis: { title: 'X Axis' },
                    // yaxis: { title: 'Y Axis' },
                };

                Plotly.newPlot('chart-container', data, layout);


                // Update the `#chart-image` src based on index like `sample-chart-${index}.svg`
                // document.getElementById("chart-image").src = `./sample-chart${index}.svg`;

                // Update the `#microphone-input` text based on prompt
                if (instruction) {
                    document.getElementById("microphone-input").innerText = `"${instruction}"`;
                } else {
                    document.getElementById("microphone-input").innerText = ``;
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        fetchDataAndRenderChart();
    </script>
</body>
</html>
